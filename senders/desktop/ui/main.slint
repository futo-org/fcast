import {
    VerticalBox,
    HorizontalBox,
} from "std-widgets.slint";
import {
    Button,
    ComboBox,
    Palette,
    Spinner,
    Switch,
    TextEdit,
    Slider,
    LineEdit,
    Palette,
    FText,
    ListView,
    ScrollView,
    Icons,
} from "../../ui-components/std-widgets.slint";
import { FocusBorder } from "../../ui-components/components.slint";
import { FCastPalette } from "../../ui-components/styling.slint";
import {
    Utils,
    VideoResolutionPicker,
    FrameratePicker,
} from "../../../sdk/mirroring_core/ui/common.slint";
import "../../ui-components/fonts/Outfit-Regular.ttf";
import { CheckBox } from "../../ui-components/checkbox.slint";

export enum UiAppState {
    Disconnected,
    Connecting,
    SelectingInputType,
    SelectingMirroringSource,
    LocalMedia,
    UnsupportedReceiver,
    StartingCast,
    Mirroring,
    YtDlp,
}

export enum UiInputType {
    LocalMedia,
    Mirroring,
}

export struct UiVideoSourceModel {
    name: string,
    uid: int,
    preview: image,
}

export struct UiAudioSourceModel {
    name: string,
    uid: int,
}

export struct UiDirectoryEntry {
    id: int,
    name: string,
}

export enum UiMediaFileType {
    Audio,
    Video,
    Image,
}

export enum UiPlaybackState {
    Idle,
    Buffering,
    Playing,
    Paused,
}

export enum UiCastProtocol {
    FCast,
    GCast,
}

export struct UiMediaFileEntry {
    id: int,
    name: string,
    type: UiMediaFileType,
}

export enum UiYtDlpState {
    Fetching,
    HasDataButFetching,
    HasData,
}

enum UiPlaybackSettingsMenuState {
    None,
    Rate,
}

export struct UiYtDlpSource {
    title: string,
}

export global Bridge {
    // in-out property <AppState> app-state: SelectingInputType;
    // in-out property <string> device-name: "FCast-localhost";
    // in property <string> current-directory: "Testing";

    in property <bool> is-audio-supported: false;
    // in property <bool> is-audio-supported: true;

    in property <bool> is-mirroring-supported: false;
    // in property <bool> is-mirroring-supported: true;

    in property <string> current-directory: "";
    in property <[string]> devices: [
        // "Test0",
        // "Test1",
        // "Test2",
        // "Test3",
        // "Test4",
    ];
    in property <string> log-string;
    in property <bool> is-yt-dlp-available: false;
    // in property <bool> is-yt-dlp-available: true;

    // in-out property <UiAppState> app-state: SelectingInputType;
    // in-out property <UiAppState> app-state: YtDlp;
    // in-out property <UiAppState> app-state: Mirroring;
    in-out property <UiAppState> app-state: Disconnected;
    // in-out property <UiAppState> app-state: LocalMedia;
    // in-out property <UiAppState> app-state: Connecting;
    // in-out property <string> device-name: "";
    in-out property <string> device-name: "Sony-BRAVIA-KD50X85";

    in-out property <string> device-ip: "192.168.1.154";

    // in-out property <string> device-name: "Test1";
    in-out property <int> selected-video-src: -1;
    // in-out property <int> selected-video-src: 0;
    in-out property <int> selected-audio-src: -1;
    in-out property <[UiVideoSourceModel]> video-sources: [
        // { uid: 0, preview: @image-url("video-source-place-holder.png"), name: "Blob 0" },
        // { uid: 1, preview: @image-url("video-source-place-holder.png"), name: "Blob 1" },
        // { uid: 2, preview: @image-url("video-source-place-holder.png"), name: "Blob 2" },
        // { uid: 3, preview: @image-url("video-source-place-holder.png"), name: "Blob 3" },
        // { uid: 4, preview: @image-url("video-source-place-holder.png"), name: "Blob 4" },
    ];
    in-out property <[UiDirectoryEntry]> directories: [
        // { id: 0, name: "Test1" },
        // { id: 0, name: "Test1" },
        // { id: 0, name: "Test1" },
        // { id: 0, name: "Test1" },
        // { id: 0, name: "Test1" },
        // { id: 0, name: "Test1" },
    ];
    in-out property <[UiMediaFileEntry]> files: [
        {
            id: 0,
            name: "Test1 aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
            type: UiMediaFileType.Audio
        },
        { id: 0, name: "Test1", type: UiMediaFileType.Audio },
        { id: 0, name: "Test1", type: UiMediaFileType.Video },
        { id: 0, name: "Test1", type: UiMediaFileType.Audio },
        { id: 0, name: "Test1", type: UiMediaFileType.Audio },
        { id: 0, name: "Test1", type: UiMediaFileType.Image },
    ];
    in-out property <float> volume: 1.0;
    in-out property <float> playback-position: 0.0;
    in-out property <UiPlaybackState> playback-state: UiPlaybackState.Idle;
    // in-out property <UiPlaybackState> playback-state: UiPlaybackState.Playing;
    in-out property <float> track-duration: 0.0;
    in-out property <string> playback-pos-str: 0.0;
    in-out property <string> track-dur-str: 0.0;
    in-out property <float> playback-rate: 1.0;
    in-out property <string> track-name: "";
    in-out property <UiMediaFileType> track-type;
    // in-out property <bool> is-showing-mirroring-popup: true;
    in-out property <UiYtDlpState> yt-dlp-state: Fetching;
    // in-out property <UiYtDlpState> yt-dlp-state: Fetching;
    // in-out property <UiYtDlpState> yt-dlp-state: HasDataButFetching;
    in-out property <string> yt-dlp-url;
    // in-out property <string> yt-dlp-url: "https://abc.def/ghi";
    in-out property <[UiYtDlpSource]> yt-dlp-sources: [
        // {
        //     title: "Test title 1",
        // },
        // {
        //     title: "Test title 2",
        // },
        // {
        //     title: "Test title 3",
        // },
    ];
    in-out property <string> yt-dlp-source;
    // in-out property <string> yt-dlp-source: "Test title 2";
    in-out property <bool> is-connecting-to-manually-inputted-device: false;

    public function clear-mirroring-state() {
        selected-video-src = -1;
        selected-audio-src = -1;
        video-sources = [];
        playback-state = UiPlaybackState.Idle;
        playback-position = 0.0;
        track-duration = 0.0;
    }

    public function clear-yt-dlp-state() {
        yt-dlp-state = UiYtDlpState.Fetching;
        yt-dlp-url = "";
        yt-dlp-sources = [];
        yt-dlp-source = "";
    }

    public function change-state(new-state: UiAppState) {
        if new-state == UiAppState.Disconnected {
            device-name = "";
            device-ip = "";
            clear-mirroring-state();
            clear-yt-dlp-state();
            directories = [];
            files = [];
            is-connecting-to-manually-inputted-device = false;
        }
        app-state = new-state;
    }

    public pure function is-valid-port(port: float) -> bool {
        port > 0.0 && port <= 65535.0
    }

    callback connect-to-device(string);
    callback select-input-type(input-type: UiInputType);
    callback start-cast(video_uid: int, include-audio: bool, scale-width: int, scale-height: int, max-framerate: int);
    callback stop-cast(disconnect: bool);
    callback reload-video-sources();
    callback reload-audio-sources();
    callback change-dir-parent();
    callback change-dir-child(dir-id: int);
    callback cast-local-media(file-id: int);
    callback seek(seconds: float, force-complete: bool);
    // When `state` is:
    //   - Idle -> Stop playback
    //   - Playing -> Resume playback
    //   - Paused -> Pause playback
    //   - Buffering -> Ignored
    callback change-playback-state(state: UiPlaybackState);
    callback change-volume(volume: float, force-complete: bool);
    callback disconnect();
    // callback connect-manually(proto: UiCastProtocol, name: string, port: int, address: string);
    callback connect-manually(url: string);
    callback reload-log-string();
    callback start-test-pattern-cast();
    callback open-url(url: string);
    callback try-play-url(url: string);
    callback cast-yt-dlp(title: string);

    // pure callback is-valid-ip-address(address: string) -> bool;
    pure callback is-device-info-valid(info: string) -> bool;
    // pure function is-device-info-valid(info: string) -> bool {true}
}

component Spacer inherits Rectangle { }

component DeviceListItem {
    in property <string> dev-name;

    forward-focus: focus-scope;

    accessible-role: list-item;

    states [
        hover when i-touch-area.has-hover: {
            // i-background.background: FCastPalette.neutral-1000;
            i-background.background: FCastPalette.brand-600.transparentize(92%);
            i-background.border-width: 1px;
            i-background.border-color: #1478DC33;
        }
    ]

    i-touch-area := TouchArea {
        clicked => {
            Bridge.device-name = dev-name;
            Bridge.connect-to-device(dev-name);
        }
    }

    i-background := Rectangle {
        background: #13151B;
        border-radius: 8px;

        VerticalLayout {
            HorizontalBox {

                Image {
                    width: 36px;
                    height: 36px;
                    source: Icons.tv;
                    vertical-alignment: center;
                }

                FText {
                    text: dev-name;
                    font-size: 16px;
                    vertical-alignment: center;
                    overflow: elide;
                }

                Spacer { }

                if Bridge.app-state == UiAppState.Connecting && Bridge.device-name == dev-name: VerticalLayout {
                    alignment: center;

                    HorizontalBox {
                        Spinner {
                            indeterminate: true;
                        }

                        FText {
                            text: "Connecting";
                            vertical-alignment: center;
                        }
                    }
                }

                if i-touch-area.has-hover && Bridge.app-state != UiAppState.Connecting: VerticalLayout {
                    alignment: center;

                    Rectangle {
                        background: FCastPalette.bg-brand-solid;
                        border-radius: 4px;
                        border-width: 1px;
                        border-color: @linear-gradient(180deg, #FFFFFF1A 0%, #FFFFFF03 100%);
                        drop-shadow-color: #0000004D;

                        i-connect-txt := HorizontalLayout {
                            padding-top: 4px;
                            padding-bottom: 4px;
                            padding-left: 12px;
                            padding-right: 12px;
                            alignment: center;

                            FText {
                                text: "Connect";
                            }
                        }
                    }
                }

                if !i-touch-area.has-hover && Bridge.app-state != UiAppState.Connecting: VerticalLayout {
                    alignment: center;

                    Rectangle {
                        background: FCastPalette.positive-1200;
                        width: i-label.preferred-width + 8px * 2;
                        height: i-label.preferred-height;
                        border-color: FCastPalette.positive-1100;
                        border-radius: 4px;
                        border-width: 1px;

                        i-label := HorizontalLayout {
                            alignment: center;
                            spacing: 6px;

                            padding-top: 4px;
                            padding-bottom: 4px;
                            padding-left: 6px;
                            padding-right: 6px;

                            VerticalLayout {
                                alignment: center;

                                Rectangle {
                                    width: 4px;
                                    height: 4px;
                                    border-radius: self.width;
                                    background: FCastPalette.status-connected;
                                }
                            }

                            available-label := FText {
                                vertical-alignment: center;
                                text: "Ready";
                                color: FCastPalette.status-connected;
                            }
                        }
                    }
                }
            }
        }
    }

    focus-scope := FocusScope {
        x: 0;
        width: 0;

        key-pressed(event) => {
            if (event.text == "\n") {
                i-touch-area.clicked();
                return accept;
            }
            return reject;
        }
    }

    if (focus-scope.has-focus): FocusBorder {
        border-radius: i-background.border-radius;
    }
}

component LabelText inherits Text {
    color: Palette.foreground;
    font-weight: 500;
    font-size: 20px;
}

component RegularText inherits Text {
    color: Palette.foreground;
    font-weight: 400;
    font-size: 16px;
}

component SecondaryText inherits Text {
    color: FCastPalette.neutral-600;
    font-weight: 300;
    font-size: 12px;
}

component Circle inherits Rectangle {
    height: self.width;
    border-width: 1.22px;
    border-radius: self.height;
    border-color: red;
}

component ConnectView inherits Rectangle {
    Rectangle {
        background: FCastPalette.neutral-1200;
        // background: FCastPalette.background-color-secondary;

        VerticalLayout {
            VerticalLayout {
                padding: 20px;

                HorizontalLayout {
                    VerticalLayout {
                        LabelText {
                            text: "Discovered receivers";
                        }

                        // HorizontalLayout {
                        //     spacing: 8px;

                            // Rectangle {
                            //     width: 4px;
                            //     height: 4px;
                            //     y: parent.height / 2 - self.height / 2;
                            //     border-radius: self.width;
                            //     background: FCastPalette.status-connected;
                            // }

                            // SecondaryText {
                            //     text: "Scanning local network (mDNS) for FCast-enabled devices...";
                            //     vertical-alignment: center;
                            //     wrap: word-wrap;
                            // }
                        // }
                    }

                    // Spacer { }

                    // HorizontalLayout {
                    //     spacing: 10px;

                    //     // broken on femtovg
                    //     // Spinner {
                    //     //     indeterminate: true;
                    //     // }

                    //     FText {
                    //         vertical-alignment: center;
                    //         text: "Scanning...";
                    //     }
                    // }
                }

                if Bridge.devices.length == 0: HorizontalLayout {
                    Spacer {}

                    VerticalLayout {
                        alignment: center;
                        spacing: 10px;

                        // Spacer {}

                        Circle {
                            width: 25%;
                            border-color: FCastPalette.border-secondary.transparentize(94%);

                            Circle {
                                width: 75%;
                                border-color: FCastPalette.border-secondary.transparentize(90%);

                                Circle {
                                    width: 70%;
                                    border-color: FCastPalette.border-secondary.transparentize(85%);

                                    Circle {
                                        width: 60%;
                                        border-color: FCastPalette.border-secondary.transparentize(80%);
                                    }
                                }
                            }
                        }


                        LabelText {
                            horizontal-alignment: center;
                            text: "No receivers found";
                        }
                    }

                    Spacer {}
                }

                if Bridge.devices.length > 0: ScrollView {
                    VerticalLayout {
                        padding-top: 20px;
                        spacing: 8px;
                        for device in Bridge.devices: DeviceListItem {
                            dev-name: device;
                        }

                        Spacer { }
                    }
                }
            }

            property <bool> is-showing-manual-connect: false;
            // property <bool> is-showing-manual-connect: true;

            Rectangle {
                height: 1px;
                background: #FFFFFF1A;
            }

            Rectangle {
                background: FCastPalette.opacity-light-1200;

                TouchArea {
                    clicked => {
                        is-showing-manual-connect = !is-showing-manual-connect;
                    }
                }

                HorizontalBox {
                    alignment: space-between;
                    padding-top: 18px;
                    padding-right: 16px;
                    padding-bottom: 18px;
                    padding-left: 16px;

                    FText {
                        text: "Unable to see the device you're looking for? Connect via IP";
                        vertical-alignment: center;
                        wrap: word-wrap;
                    }

                    VerticalLayout {
                        alignment: center;

                        Rectangle {
                            width: 18.66px;
                            height: 18.67px;
                            border-radius: self.height;
                            background: #FFFFFF1A;

                            Image {
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                width: 8.8px;
                                height: 5.1px;
                                source: Icons.arrow-down;
                                colorize: FCastPalette.neutral-500;
                            }
                        }
                    }
                }
            }

            if is-showing-manual-connect: VerticalLayout {
                padding-top: 18px;
                padding-right: 16px;
                padding-bottom: 18px;
                padding-left: 16px;

                Rectangle {
                    height: 1px;
                    background: FCastPalette.border-subtle;
                }

                HorizontalLayout {
                    padding-top: 18px;
                    padding-right: 16px;
                    padding-bottom: 18px;
                    padding-left: 16px;

                    i-left := VerticalLayout {
                        padding-right: 12px;
                        spacing: 6px;

                        HorizontalLayout {
                            spacing: 8px;

                            i-dev-info-input := LineEdit {
                                placeholder-text: "<fcast/gcast>://<ip>:<port>";
                            }

                            if !Bridge.is-connecting-to-manually-inputted-device: Button {
                                enabled: Bridge.is-device-info-valid(i-dev-info-input.text);
                                text: "Connect";

                                clicked => {
                                    Bridge.connect-manually(i-dev-info-input.text);
                                    Bridge.is-connecting-to-manually-inputted-device = true;
                                }
                            }

                            if Bridge.is-connecting-to-manually-inputted-device: Button {
                                text: "Cancel";

                                clicked => {
                                    Bridge.disconnect();
                                }
                            }
                        }

                        SecondaryText {
                            text: "Use this for devices on different subnets or VPNs. (port 46899).";
                        }
                    }

                    Rectangle {
                        width: 1px;
                        height: Math.max(i-right.preferred-height, i-left.preferred-height);
                        background: FCastPalette.border-subtle;
                    }

                    i-right := VerticalLayout {
                        padding-left: 12px;

                        FText {
                            text: "Device not listed?";
                        }

                        SecondaryText {
                            text: "FCast requires a Receiver App running on your target device before it appears here.";
                            wrap: word-wrap;
                        }

                        Rectangle {
                            TouchArea {
                                mouse-cursor: pointer;

                                clicked => {
                                    Bridge.open-url("https://fcast.org/");
                                }
                            }

                            HorizontalLayout {
                                spacing: 5.5px;

                                SecondaryText {
                                    vertical-alignment: center;
                                    color: FCastPalette.brand-600;
                                    text: "Get the receiver app";
                                }

                                VerticalLayout {
                                    alignment: center;

                                    Image {
                                        source: Icons.open-external;
                                        width: 9px;
                                        height: 9px;
                                    }
                                }

                                Spacer { }
                            }
                        }
                    }
                }
            }
        }
    }
}

component LabelBox inherits Rectangle {
    in property <string> label;

    background: FCastPalette.neutral-1200;
    border-width: 1px;
    border-color: #202227;
    border-radius: 4px;
    height: i-vl.preferred-height;

    i-vl := VerticalLayout {
        padding: 4px;
        padding-left: 6px;
        padding-right: 6px;

        FText {
            text: label;
            font-family: "Overfit Mono";
            font-size: 12px;
            font-weight: 400;
            color: FCastPalette.text-secondary;
            overflow: elide;
        }
    }
}

component SourceItem inherits Rectangle {
    out property <bool> has-hover: i-touch-area.has-hover;
    in property <string> label;
    in property <string> description;
    in property <image> icon;
    in property <color> icon-bg-color;
    in property <bool> enabled: true;

    callback clicked;

    background: FCastPalette.neutral-1100;
    border-color: FCastPalette.neutral-1000;
    border-width: 1px;
    border-radius: 6px;
    preferred-width: 0px;

    states [
        hover when root.enabled && i-touch-area.has-hover: {
            border-color: FCastPalette.brand-600;
        }
        disabled when !root.enabled: {
            i-icon-bg.background: FCastPalette.neutral-600.transparentize(80%);
            i-icon.colorize: FCastPalette.neutral-600;
            root.background: FCastPalette.neutral-800.transparentize(90%);
            i-title.color: FCastPalette.neutral-600;
        }
    ]

    VerticalBox {
        padding-top: 20px;
        padding-bottom: 20px;

        HorizontalLayout {
            alignment: center;
            i-icon-bg := Rectangle {
                background: icon-bg-color;
                width: 64px;
                height: 64px;
                border-radius: self.height;

                i-icon := Image {
                    source: icon;
                }
            }
        }

        i-title := RegularText {
            horizontal-alignment: center;
            text: label;
        }

        SecondaryText {
            horizontal-alignment: center;
            wrap: word-wrap;
            text: description;

            states [
                hover when i-touch-area.has-hover: {
                    color: white;
                }
            ]
        }
    }

    i-touch-area := TouchArea {
        enabled: root.enabled;

        clicked => {
            root.clicked();
        }
    }

    i-focus-scope := FocusScope {
        x: 0;
        width: 0;
        enabled: root.enabled;

        key-pressed(event) => {
            if (event.text == " " || event.text == "\n") {
                i-touch-area.clicked();
                return accept;
            }
            return reject;
        }
    }

    if (root.enabled && i-focus-scope.has-focus): FocusBorder {
        border-radius: root.border-radius;
    }
}

component ImageBackground {
    in property <length> img-width;
    in property <length> img-height;

    Image {
        width: img-width;
        height: img-height;
        source: Icons.background;
    }

    Rectangle {
        width: img-width;
        height: img-height;
        background: FCastPalette.background-color-primary.transparentize(60%);
    }
}

component DisconnectButton inherits Button {
    icon: Icons.disconnect;
    text: "Disconnect";
    text-color: FCastPalette.negative-600;
    background-default-drop-shadow-color: transparent;
    background-default-color: transparent;
    border-color: FCastPalette.negative-600.transparentize(80%);

    clicked => {
        Bridge.disconnect();
    }
}

component ReadyToCastView inherits Rectangle {
    callback show-mirroring;
    callback show-local-media;
    callback show-yt-dlp-view;

    ImageBackground {
        img-width: root.width;
        img-height: root.height;
    }

    Rectangle {
        VerticalLayout {
            spacing: 8px;

            // VerticalBox {
            padding-top: 40px;
            // padding-left: 20px;
            padding: 20px;

            SecondaryText {
                text: "CONNECTED TO";
                font-family: "Overfit Mono"; // TODO: fix
                font-size: 10px;
            }

            HorizontalLayout {
                alignment: space-between;

                LabelText {
                    font-size: 22px;
                    text: Bridge.device-name;
                }

                DisconnectButton { }
            }

            HorizontalLayout {
                LabelBox {
                    label: Bridge.device-ip;
                }

                Spacer { }
            }

            SecondaryText {
                text: "Receiver is idle. Select media to start streaming.";
                vertical-alignment: center;
            }

            if Bridge.is-yt-dlp-available: HorizontalLayout {
                spacing: 8px;

                // TODO: check that url is valid/supported (i.e. we can detect mime type from extension)
                i-line-edit-url := LineEdit {
                    placeholder-text: "Paste URL (http/https, .mp4, .m3u8)...";
                    icon: Icons.link;
                }

                Button {
                    width: self.preferred-width + 30px;
                    text: "Cast";
                    enabled: !i-line-edit-url.text.is-empty;
                    background-default-color: FCastPalette.brand-600;

                    clicked => {
                        Bridge.clear-yt-dlp-state();
                        show-yt-dlp-view();
                        Bridge.yt-dlp-url = i-line-edit-url.text;
                        Bridge.try-play-url(i-line-edit-url.text);
                        i-line-edit-url.text = "";
                    }
                }
            }

            GridLayout {
                padding-top: 20px;
                spacing: 10px;

                i-cast-media-item := SourceItem {
                    label: "Cast media file";
                    description: "Cast MP4, MKV, or MP3 files directly from your hard drive with zero compression.";
                    icon: Icons.folder-fcast;
                    icon-bg-color: #2889E821;
                    enabled: false;

                    clicked => {
                        show-local-media();
                    }
                }

                i-mirroring-item := SourceItem {
                    label: "Mirror screen";
                    description: "Share your entire desktop or a specific window. Low latency for demos and presentations.";
                    icon: Icons.mirror;
                    icon-bg-color: #7C3AED29;
                    enabled: Bridge.is-mirroring-supported;

                    clicked => {
                        Bridge.select-input-type(UiInputType.Mirroring);
                        show-mirroring();
                    }
                }

                i-test-pattern-item := SourceItem {
                    label: "Video test pattern";
                    description: "Validate display settings, network latency, and audio synchronization.";
                    icon: Icons.media-file;
                    icon-bg-color: #DB8C0E33;
                    enabled: Bridge.is-mirroring-supported;

                    clicked => {
                        Bridge.start-test-pattern-cast();
                        Bridge.app-state = UiAppState.Mirroring;
                    }
                }
            }

            Spacer { }
        }
    }
}

component SoundBar inherits Rectangle {
    in property <duration> offset;
    in property <length> max-bar-height;

    property <float> anim: 1 * mod(animation-tick() + offset, 1.2s) / 1.2s;

    height: 5px + (max-bar-height - 5px) * sin(anim * 180deg);
    border-radius: 2px;
    background: FCastPalette.foreground;
}

component SoundAnimator inherits Rectangle {
    property <length> spacing: 2px;
    property <length> bar-width: 5px;
    property <length> max-bar-height: 20px;

    width: 3 * spacing + 3 * bar-width;
    height: max-bar-height;

    SoundBar {
        offset: 0s;
        width: bar-width;
        y: root.height - self.height;
        max-bar-height: max-bar-height;
        x: 0;
    }

    SoundBar {
        offset: 0.8s;
        width: bar-width;
        y: root.height - self.height;
        max-bar-height: max-bar-height;
        x: bar-width + spacing;
    }

    SoundBar {
        offset: 0.3s;
        width: bar-width;
        y: root.height - self.height;
        max-bar-height: max-bar-height;
        x: 2 * (bar-width + spacing);
    }
}

component YtDlpSourceItem inherits Rectangle {
    in property <UiYtDlpSource> source;

    callback cast-this;

    border-radius: 6px;

    states [
        hover when i-touch-area.has-hover: {
            root.background: FCastPalette.neutral-1100;
        }
    ]

    i-touch-area := TouchArea {
        clicked => {
            if Bridge.yt-dlp-source == source.title {
                Bridge.change-playback-state(UiPlaybackState.Idle);
                Bridge.yt-dlp-source = "";
            } else {
                root.cast-this();
            }
        }
    }

    HorizontalLayout {
        padding: 10px;

        FText {
            vertical-alignment: center;
            text: source.title;
            overflow: elide;
        }

        Spacer { }

        if !i-touch-area.has-hover && Bridge.playback-state == UiPlaybackState.Playing && Bridge.yt-dlp-source == source.title: SoundAnimator { }

        if Bridge.yt-dlp-source != source.title && i-touch-area.has-hover: Rectangle {
            background: FCastPalette.brand-600;
            border-radius: 6px;
            // visible: i-touch-area.has-hover;

            VerticalLayout {
                padding: 8px;
                padding-top: 4px;
                padding-bottom: 4px;

                FText {
                    text: "Cast";
                }
            }
        }

        if Bridge.yt-dlp-source == source.title && i-touch-area.has-hover: Rectangle {
            background: FCastPalette.brand-600;
            border-radius: 6px;
            // visible: i-touch-area.has-hover;

            VerticalLayout {
                padding: 8px;
                padding-top: 4px;
                padding-bottom: 4px;

                FText {
                    text: "Stop";
                }
            }
        }
    }

    focus-scope := FocusScope {
        x: 0;
        width: 0;

        key-pressed(event) => {
            if (event.text == "\n") {
                i-touch-area.clicked();
                return accept;
            }
            return reject;
        }
    }

    if (focus-scope.has-focus): FocusBorder {
        border-radius: root.border-radius;
    }
}

component PlaybackSettingsMenuItem inherits Rectangle {
    in property <string> label;
    in property <image> icon;

    callback clicked;

    border-radius: 6px;

    states [
        hover when i-ta-playback-rate.has-hover: {
            i-playback-rate-text.color: FCastPalette.foreground;
            i-playback-rate-arrow-icon.colorize: FCastPalette.foreground;
            background: FCastPalette.brand-600;
        }
    ]

    i-ta-playback-rate := TouchArea {
        clicked => root.clicked();
    }

    HorizontalLayout {
        padding: 8px;
        padding-top: 14px;
        padding-bottom: 14px;
        spacing: 8px;

        VerticalLayout {
            alignment: center;

            Image {
                width: 16px;
                height: 16px;
                // source: @image-url("playback_rate.svg");
                source: icon;
            }
        }

        i-playback-rate-text := FText {
            // text: "Playback Rate";
            text: label;
            color: FCastPalette.neutral-500;
        }

        Spacer {}

        VerticalLayout {
            alignment: center;

            i-playback-rate-arrow-icon := Image {
                width: 4.67px;
                height: 8px;
                source: Icons.arrow-right;
            }
        }
    }
}

component PlaybackControls inherits Rectangle {
    background: FCastPalette.neutral-1200;

    states [
        playing when Bridge.playback-state == UiPlaybackState.Playing: {
            i-master-button.icon: Icons.pause;
            i-master-button.enabled: true;
        }
        paused when Bridge.playback-state == UiPlaybackState.Paused: {
            i-master-button.icon: Icons.play;
            i-master-button.enabled: true;
        }
    ]

    property <UiPlaybackSettingsMenuState> menu-state: UiPlaybackSettingsMenuState.None;

    VerticalLayout {
        alignment: center;
        padding-top: 20px;
        padding-right: 24px;
        padding-bottom: 20px;
        padding-left: 24px;

        HorizontalLayout {
            spacing: 16px;

            FText {
                text: Bridge.playback-pos-str;
                font-weight: 300;
                vertical-alignment: center;
            }

            Slider {
                hide-thumb: true;
                value <=> Bridge.playback-position;
                maximum: Bridge.track-duration;

                changed(new-time) => {
                    Bridge.seek(new-time, false);
                }

                released(new-time) => {
                    Bridge.seek(new-time, true);
                }
            }

            FText {
                text: Bridge.track-dur-str;
                font-weight: 300;
                vertical-alignment: center;
            }
        }

        HorizontalLayout {
            padding-top: 12px;
            alignment: space-between;

            Spacer { }

            i-master-button := Button {
                height: 40px;
                width: 40px;
                icon-size: 15px;
                enabled: false;

                clicked => {
                    Bridge.change-playback-state(
                        Bridge.playback-state == UiPlaybackState.Playing ? UiPlaybackState.Paused : UiPlaybackState.Playing);
                }
            }

            // TODO: should show e.g. playback rate
            settings-btn := Button {
                height: 40px;
                width: 40px;
                icon: Icons.settings;
                icon-size: 18px;

                clicked => {
                    // i-settings-popup.x = self.x;
                    // i-settings-popup.y = self.y;
                    i-settings-popup.show();
                }
            }

        }
    }

    i-settings-popup := PopupWindow {
        width: settings-rect.preferred-width;
        height: settings-rect.preferred-height;

        x: settings-btn.x - self.width + settings-btn.width;
        y: settings-btn.y - self.height - 10px;
        close-policy: close-on-click-outside;

        settings-rect := Rectangle {
            background: @linear-gradient(180deg, #202022 0%, #0F0F10 100%);
            border-color: @radial-gradient(circle, rgba(255, 255, 255, 0.04) 0%, rgba(102, 102, 102, 0.04) 100%);
            border-width: 1px;
            border-radius: 6px;
            forward-focus: inner-fs;

            inner-fs := FocusScope {
                VerticalLayout {
                    padding: 10px;
                    padding-top: 15px;

                    // property <UiPlaybackSettingsMenuState> menu-state: UiPlaybackSettingsMenuState.None;

                    states [
                        none when menu-state == UiPlaybackSettingsMenuState.None: {
                            i-settings-label.text: "Playback settings";
                        }
                        rate when menu-state == UiPlaybackSettingsMenuState.Rate: {
                            i-settings-label.text: "Playback rate";
                        }
                    ]

                    HorizontalLayout {
                        spacing: 10px;

                        if menu-state == UiPlaybackSettingsMenuState.Rate: Rectangle {
                            TouchArea {
                                clicked => {
                                    menu-state = UiPlaybackSettingsMenuState.None;
                                    i-settings-popup.show();
                                }
                            }

                            FText {
                                text: "<";
                            }
                        }

                        i-settings-label := LabelText {
                            font-size: 16px;
                        }
                    }

                    if menu-state == UiPlaybackSettingsMenuState.None: VerticalLayout {
                        padding-top: 10px;
                        spacing: 5px;

                        PlaybackSettingsMenuItem {
                            label: "Playback rate";
                            icon: Icons.playback-rate;

                            clicked => {
                                menu-state = UiPlaybackSettingsMenuState.Rate;
                                i-settings-popup.show();
                            }
                        }

                        Rectangle {
                            height: 1px;
                            background: #FFFFFF0A;
                        }
                    }

                    if menu-state == UiPlaybackSettingsMenuState.Rate: VerticalLayout {
                        padding-top: 10px;
                        spacing: 5px;

                        property <[float]> rates: [0.25, 0.5, 0.75, 1.0, 1.25, 1.50, 1.75, 2.0];

                        for rate in rates: HorizontalLayout {
                            FText {
                                text: rate;
                            }
                        }
                    }
                }
            }
        }
    }
}

component YtDlpView inherits Rectangle {
    ImageBackground {
        img-width: root.width;
        img-height: root.height;
    }

    VerticalLayout {
        VerticalLayout {
            padding: 20px;
            spacing: 10px;

            HorizontalLayout {
                LabelBox {
                    label: Bridge.yt-dlp-url;
                }

                Spacer { }

                DisconnectButton { }
            }

            if Bridge.yt-dlp-state == UiYtDlpState.HasData && Bridge.yt-dlp-sources.length == 0: FText {
                text: "No supported sources found in provided URL";
                horizontal-alignment: center;
            }

            if Bridge.yt-dlp-state == UiYtDlpState.HasData || Bridge.yt-dlp-state == UiYtDlpState.HasDataButFetching: ListView {
                for source in Bridge.yt-dlp-sources: YtDlpSourceItem {
                    source: source;

                    cast-this => {
                        Bridge.cast-yt-dlp(source.title);
                        Bridge.yt-dlp-source = source.title;
                    }
                }
            }

            if Bridge.yt-dlp-state == UiYtDlpState.Fetching || Bridge.yt-dlp-state == UiYtDlpState.HasDataButFetching: HorizontalLayout {
                alignment: center;
                spacing: 10px;

                Spinner {
                    indeterminate: true;
                }

                FText {
                    vertical-alignment: center;
                    text: "Fetching...";
                }
            }
        }

        if Bridge.playback-state == UiPlaybackState.Playing || Bridge.playback-state == UiPlaybackState.Paused: Rectangle {
            background: FCastPalette.border-subtle;
            height: 1px;
        }

        if Bridge.playback-state == UiPlaybackState.Playing || Bridge.playback-state == UiPlaybackState.Paused: PlaybackControls { }
    }
}

component MirroringView inherits Rectangle {
    ImageBackground {
        img-width: root.width;
        img-height: root.height;
    }

    VerticalLayout {
        padding: 20px;
        spacing: 10px;

        LabelText {
            text: "Mirroring";
        }

        Button {
            text: "Stop";

            clicked => {
                Bridge.stop-cast(false);
                Bridge.clear-mirroring-state();
                Bridge.app-state = UiAppState.SelectingInputType;
            }
        }
    }
}

component LocalMediaView inherits Rectangle {
    ImageBackground {
        img-width: root.width;
        img-height: root.height;
    }

    VerticalLayout {
        Spacer { }

        Rectangle {
            background: FCastPalette.border-subtle;
            height: 1px;
        }

        Rectangle {
            background: FCastPalette.neutral-1200;

            VerticalLayout {
                alignment: center;
                padding-top: 20px;
                padding-right: 24px;
                padding-bottom: 20px;
                padding-left: 24px;

                HorizontalLayout {
                    spacing: 16px;

                    FText {
                        text: "00:53:12";
                        font-weight: 300;
                        vertical-alignment: center;
                    }

                    Slider {
                        hide-thumb: true;
                    }

                    FText {
                        text: "01:54:00";
                        font-weight: 300;
                        vertical-alignment: center;
                    }
                }

                HorizontalLayout {
                    padding-top: 12px;
                    alignment: space-between;

                    Spacer { }

                    Button {
                        height: 40px;
                        width: 40px;
                        icon: Icons.pause;
                        icon-size: 15px;
                    }

                    Button {
                        height: 40px;
                        width: 40px;
                        icon: Icons.settings;
                        icon-size: 18px;
                    }
                }
            }
        }
    }
}

component FCastPopupWindow inherits Rectangle {
    in property <string> title;

    callback close;

    background: FCastPalette.neutral-1200;
    border-color: FCastPalette.border-subtle;
    border-width: 1px;
    border-radius: 6px;

    FocusScope {
        capture-key-pressed(key) => {
            if key.text == Key.Escape {
                close();
                accept
            } else {
                reject
            }
        }
    }

    VerticalLayout {
        padding: 24px;

        HorizontalLayout {
            alignment: space-between;

            LabelText {
                text: title;
            }

            Button {
                width: 36px;
                height: 36px;
                icon: Icons.close;
                icon-size: 13.33px;
                clicked => close();
            }
        }

        @children
    }
}

component VideoSourceItem inherits Rectangle {
    in property <int> id;
    in property <image> preview;
    in property <string> name;

    border-width: 1px;
    border-color: Bridge.selected-video-src == id ? FCastPalette.brand-600 : FCastPalette.border-subtle;
    border-radius: 6px;
    background: FCastPalette.neutral-1200;

    states [
        hover when i-touch-area.has-hover: {
            background: FCastPalette.neutral-1100;
        }
    ]

    VerticalLayout {
        padding: 15px;
        spacing: 10px;

        Rectangle {
            border-radius: 6px;
            clip: true;

            Image {
                width: 100%;
                height: 100%;
                image-fit: contain;
                source: preview;
            }
        }

        LabelText {
            text: name;
            font-size: 14px;
        }
    }

    i-touch-area := TouchArea {
        clicked => {
            if Bridge.selected-video-src == id {
                Bridge.selected-video-src = -1;
            } else {
                Bridge.selected-video-src = id;
            }
        }
    }

    i-focus-scope := FocusScope {
        x: 0;
        width: 0; // Do not react on clicks

        key-pressed(event) => {
            if (event.text == " " || event.text == "\n") {
                i-touch-area.clicked();
                return accept;
            }
            return reject;
        }
    }

    if (i-focus-scope.has-focus): FocusBorder {
        border-radius: 6px;
    }
}

component LocalMediaPopup inherits FCastPopupWindow {
    title: "Local media";

    VerticalLayout {
        padding-top: 20px;

        Rectangle {
            border-width: 1px;
            border-color: FCastPalette.opacity-light-1000;
            border-radius: 6px;
            clip: true;

            HorizontalLayout {
                alignment: center;

                VerticalLayout {
                    alignment: center;
                    spacing: 6px;

                    Rectangle {
                        width: 70px;
                        height: 70px;
                        x: parent.width / 2 - self.width / 2;
                        border-radius: self.height;
                        background: FCastPalette.neutral-1100;

                        Image {
                            source: Icons.upload;
                            colorize: FCastPalette.neutral-600;
                            width: 30.83px;
                            height: 35px;
                        }
                    }

                    LabelText {
                        horizontal-alignment: center;
                        text: "~Drag & drop video files~";
                    }

                    SecondaryText {
                        font-size: 14px;
                        horizontal-alignment: center;
                        text: "or browse files on your computer";
                    }
                }
            }
        }
    }
}

component MirroringPopup inherits FCastPopupWindow {
    title: "Mirror screen";

    property <length> spacing: 20px;
    property <int> n-columns: compute-columns(i-vl.width);

    callback hide;

    pure function compute-columns(width: length) -> int {
        if width > 1300px {
            4
        } else if width > 800px {
            3
        } else if width > 500px {
            2
        } else {
            1
        }
    }

    pure function compute-width(idx: int, root-width: length) -> length {
        (root-width - spacing) / n-columns
    }

    pure function compute-x(idx: int, width: length) -> length {
        let col = Math.mod(idx, n-columns);
        let offset = col == 0 ? 0px : spacing * col;
        offset + col * width;
    }

    pure function compute-y(idx: int, root-width: length) -> length {
        let row = Math.floor(idx / n-columns);
        let height = 250px;
        let offset = row == 0 ? 0px : spacing * row;
        offset + row * height
    }

    property <int> y-items: Math.ceil(Bridge.video-sources.length / n-columns);
    property <int> video-resolution-idx: 2;
    property <int> video-framerate-idx: 2;

    i-vl := VerticalLayout {
        padding-top: 24px;

        ScrollView {
            viewport-height: (250px + spacing) * y-items;

            for src[idx] in Bridge.video-sources: VideoSourceItem {
                x: compute-x(idx, compute-width(idx, parent.visible-width - spacing * (n-columns - 1)));
                width: compute-width(idx, parent.visible-width - spacing);
                y: compute-y(idx, parent.height);
                height: 250px;
                id: src.uid;
                preview: src.preview;
                name: src.name;
            }
        }

        if Bridge.selected-video-src != -1: HorizontalLayout {
            spacing: 8px;

            FText {
                vertical-alignment: center;
                text: "Resolution";
            }

            VideoResolutionPicker {
                current-index <=> video-resolution-idx;
            }

            FText {
                vertical-alignment: center;
                text: "Framerate";
            }

            FrameratePicker {
                current-index <=> video-framerate-idx;
            }
        }

        property <bool> include-audio: false;

        if Bridge.is-audio-supported: CheckBox {
            checked <=> include-audio;
            text: "Share system audio";
        }

        if Bridge.is-audio-supported: SecondaryText {
            text: "Captures desktop output sounds";
        }

        HorizontalLayout {
            Spacer { }

            Button {
                enabled: include-audio || Bridge.selected-video-src != -1;
                text: "Start Casting";
                background-default-color: FCastPalette.brand-600;

                clicked => {
                    let scale = Utils.str-to-scale(video-resolution-idx);
                    Bridge.start-cast(
                        Bridge.selected-video-src,
                        include-audio,
                        scale.width,
                        scale.height,
                        Utils.video-framerates[video-framerate-idx].to-float(),
                    );
                    Bridge.app-state = UiAppState.Mirroring;
                    root.hide();
                }
            }
        }
    }
}

component BackView inherits Rectangle {
    // property <bool> is-showing-mirroring-popup: true;
    property <bool> is-showing-mirroring-popup: false;
    // property <bool> is-showing-log-popup: true;
    property <bool> is-showing-log-popup: false;
    // property <bool> is-showing-local-media-popup: true;
    property <bool> is-showing-local-media-popup: false;

    HorizontalLayout {
        Rectangle {
            width: root.width > 700px ? 266px : 0px;
            // background: FCastPalette.background-color-primary;
            background: FCastPalette.neutral-1100;
            border-width: 1px;
            border-color: FCastPalette.border-subtle;

            animate width { duration: 50ms; }

            VerticalLayout {
                padding: 20px;
                spacing: 5px;

                Image {
                    source: Icons.fcast;
                    width: 48px;
                }

                HorizontalLayout {
                    padding-top: 20px;

                    FText {
                        text: "FCast Sender";
                        font-size: 20px;
                        font-weight: 900;
                        // height: 42px;
                        // vertical-alignment: bottom;
                        vertical-alignment: center;
                    }

                    Spacer {}

                    LabelBox {
                        label: "BETA";
                    }
                }

                FText {
                    text: "Scanning local network (mDNS) for FCast-enabled devices...";
                    // text: "Make sure the FCast Receiver app is open and the device is connected to Wi-Fi or your home network. Once connected, the FCast Sender app will find it automatically.";
                    wrap: word-wrap;
                    font-size: 12px;
                    color: grey;
                }

                Spacer { }

                Rectangle {
                    background: FCastPalette.neutral-1100;
                    height: 1px;
                }

                Rectangle {
                    i-dev-log-ta := TouchArea {
                        clicked => {
                            Bridge.reload-log-string();
                            is-showing-log-popup = true;
                        }
                    }

                    HorizontalLayout {
                        padding-top: 15px;
                        padding-bottom: 15px;

                        spacing: 10px;

                        VerticalLayout {
                            alignment: center;

                            Image {
                                width: 12px;
                                height: 12px;
                                source: Icons.dev-log;
                                colorize: FCastPalette.neutral-600;

                                states [
                                    hover when i-dev-log-ta.has-hover: {
                                        colorize: FCastPalette.brand-600;
                                    }
                                ]
                            }
                        }

                        FText {
                            font-weight: 500;
                            font-size: 14px;
                            color: FCastPalette.neutral-600;
                            text: "Developer log";

                            states [
                                hover when i-dev-log-ta.has-hover: {
                                    color: FCastPalette.brand-600;
                                }
                            ]
                        }
                    }
                }
            }
        }

        if Bridge.app-state == UiAppState.Disconnected || Bridge.app-state == UiAppState.Connecting: ConnectView { }

        if Bridge.app-state == UiAppState.SelectingInputType: ReadyToCastView {
            show-mirroring => {
                is-showing-mirroring-popup = true;
            }

            show-local-media => {
                is-showing-local-media-popup = true;
            }

            show-yt-dlp-view => {
                Bridge.app-state = UiAppState.YtDlp;
            }
        }

        if Bridge.app-state == UiAppState.YtDlp: YtDlpView { }

        if Bridge.app-state == UiAppState.StartingCast || Bridge.app-state == UiAppState.Mirroring: MirroringView { }

        if Bridge.app-state == UiAppState.LocalMedia: LocalMediaView { }
    }

    if is-showing-local-media-popup || is-showing-mirroring-popup || is-showing-log-popup: Rectangle {
        background: #0000009C;
        TouchArea { }
    }

    if is-showing-local-media-popup: LocalMediaPopup {
        width: root.width * 75%;
        height: root.height * 85%;

        close => {
            is-showing-local-media-popup = false;
        }
    }

    if is-showing-mirroring-popup: MirroringPopup {
        width: root.width * 75%;
        height: root.height * 85%;

        hide => {
            is-showing-mirroring-popup = false;
        }

        close => {
            is-showing-mirroring-popup = false;
            Bridge.stop-cast(false);
            Bridge.clear-mirroring-state();
            Bridge.app-state = UiAppState.SelectingInputType;
        }
    }

    if is-showing-log-popup: FCastPopupWindow {
        width: root.width * 95%;
        height: root.height * 95%;
        title: "Developer Log";

        close => {
            is-showing-log-popup = false;
        }

        VerticalLayout {
            padding-top: 24px;

            TextEdit {
                text: Bridge.log-string;
                read-only: true;
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "FCast Sender";

    preferred-width: 800px;
    preferred-height: 500px;

    default-font-family: "Outfit";
    default-font-size: 15px;
    default-font-weight: 400;

    background: FCastPalette.background-color-primary;

    BackView { }
}

export component CrashWindow inherits Window {
    title: "FCast Sender Crash Reporter";

    preferred-width: 800px;
    preferred-height: 500px;

    default-font-family: "Outfit";
    default-font-size: 15px;
    default-font-weight: 400;

    background: FCastPalette.background-color-primary;

    in property <string> log: "";

    VerticalBox {
        FText {
            font-weight: 600;
            font-size: 18px;
            horizontal-alignment: center;
            vertical-alignment: center;
            wrap: word-wrap;
            text: "FCast Sender encountered an error!";
        }

        FText {
            font-size: 18px;
            horizontal-alignment: center;
            vertical-alignment: center;
            wrap: word-wrap;
            text: "Please report your issue including the log below to: https://github.com/futo-org/fcast/issues";
        }

        TextEdit {
            text: log;
            read-only: true;
        }
    }
}
