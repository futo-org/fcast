import { VerticalBox, Button, ListView, Spinner } from "std-widgets.slint";
import { Utils, VideoResolutionPicker, FrameratePicker } from "../../../sdk/mirroring_core/ui/common.slint";

enum AppState {
    Disconnected,
    Connecting,
    SelectingSettings,
    WaitingForMedia,
    Casting,
}

export global Bridge {
    in property <[string]> devices: [
        // "Device 1", "Device 2",
    ];
    in-out property <AppState> app-state: AppState.Disconnected;

    callback connect-receiver(string);
    callback start-casting(scale-width: int, scale-height: int, max-framerate: int);
    callback stop-casting();
    callback scan-qr();

    public function change-state(to: AppState) {
        Bridge.app-state = to;
    }
}

component ConnectView inherits Rectangle {
    VerticalBox {
        Text {
            horizontal-alignment: center;
            font-size: 16px;
            font-weight: 600;
            text: "Connect to your receiver";
        }

        ListView {
            for device in Bridge.devices: Rectangle {
                height: 45px;

                TouchArea {
                    clicked => Bridge.connect-receiver(device);
                }

                Rectangle {
                    width: parent.width - 10px;
                    height: parent.height - 10px;
                    background: lightsteelblue;
                    border-radius: 8px;
                    Text {
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        text: device;
                    }
                }
            }
        }

        Rectangle {
            height: 45px;

            TouchArea {
                clicked => Bridge.scan-qr();
            }

            Rectangle {
                width: parent.width - 10px;
                height: parent.height - 10px;
                background: lightsteelblue;
                border-radius: 8px;
                Text {
                    vertical-alignment: center;
                    horizontal-alignment: left;
                    text: "Scan QR";
                }
            }
        }
    }
}

component ConnectingView inherits Rectangle {
    VerticalBox {
        Spinner {
            indeterminate: true;
        }

        Text {
            font-size: 12pt;
            vertical-alignment: center;
            text: "Connecting";
        }

        // TODO: cancel button
    }
}

component SelectingSettingsView inherits Rectangle {
    property <int> video-resolution-idx: 2;
    property <int> video-framerate-idx: 2;

    VerticalBox {
        Text {
            font-size: 12pt;
            vertical-alignment: center;
            text: "Max resolution";
        }

        VideoResolutionPicker {
            current-index <=> video-resolution-idx;
        }

        Text {
            font-size: 12pt;
            vertical-alignment: center;
            text: "Max framerate";
        }

        FrameratePicker {
            current-index <=> video-framerate-idx;
        }

        Button {
            text: "Start";
            clicked => {
                let scale = Utils.str-to-scale(video-resolution-idx);
                Bridge.start-casting(scale.width, scale.height, Utils.video-framerates[video-framerate-idx].to-float())
            }
        }
    }
}

component WaitingForMediaView inherits Rectangle {
    VerticalBox {
        Text {
            horizontal-alignment: center;
            text: "Waiting for media";
        }
    }
}

component CastingView inherits Rectangle {
    VerticalBox {
        Text {
            horizontal-alignment: center;
            text: "Casting";
        }

        Button {
            text: "Stop";
            clicked => Bridge.stop-casting();
        }
    }
}

export component MainWindow inherits Window {
    if Bridge.app-state == AppState.Disconnected: ConnectView { }

    if Bridge.app-state == AppState.Connecting: ConnectingView {}

    if Bridge.app-state == AppState.SelectingSettings: SelectingSettingsView {}

    if Bridge.app-state == AppState.WaitingForMedia: WaitingForMediaView { }

    if Bridge.app-state == AppState.Casting : CastingView {}
}
