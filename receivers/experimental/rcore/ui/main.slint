import {
    Icons,
    FText,
    ScrollView,
    Spinner,
    Button,
    Palette,
    ListView,
    Slider,
} from "../../../../senders/ui-components/std-widgets.slint";
import { FCastPalette } from "../../../../senders/ui-components/styling.slint";
import "../../../../senders/ui-components/fonts/Outfit-Regular.ttf";
import {
    Bridge,
    GuiPlaybackState,
    AppState,
    UiPlayerVariant,
} from "globals.slint";
import { DebugOverlay } from "debug.slint";
import { IdleView } from "views/idle.slint";
import { LoadingMediaView } from "views/loading-media.slint";
import { VideoPlayerView } from "views/video-player.slint";
import { ImageView } from "views/image.slint";
import { AudioPlayerView } from "views/audio.slint";

// TODO: animate in and out transitions
component ErrorAlert {
    in property <string> message;

    visible: false;

    public function show() {
        self.visible = true;
        timer.counter = 0;
        timer.running = true;
    }

    function close() {
        self.visible = false;
        timer.running = true;
    }

    states [
        hover when ta.has-hover: {
            im.colorize: #DEDEDE;
        }
    ]

    Rectangle {
        height: hb.preferred-height;
        background: #FF4131;
        border-radius: 8px;

        hb := VerticalLayout {
            spacing: 10px;
            alignment: space-between;

            Text {
                color: white;
                vertical-alignment: center;
                text <=> message;
                wrap: word-wrap;
                font-weight: 800;
            }

            ta := TouchArea {
                height: 32px;
                width: 32px;
                clicked => {
                    root.close();
                }
                Rectangle {
                    im := Image {
                        height: 100%;
                        // source: @image-url("../../assets/icons/xmark.svg");
                        colorize: white;
                        animate colorize { duration: 150ms; }
                    }
                }
            }
        }
    }

    timer := Timer {
        property <int> counter: 0;
        interval: 1s;
        running: true;
        triggered => {
            counter += 1;
            if counter >= 4 {
                root.close();
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "FCast Receiver";

    default-font-family: "Outfit";
    default-font-size: 15px;
    default-font-weight: 400;

    public function playback-started() {
        Bridge.playing = true;
        // playback-control.playback-started();
    }

    public function device-connected() {
        Bridge.connected_devices += 1;
    }

    // public function device-disconnected() {
    //     Bridge.connected_devices = max(Bridge.connected_devices - 1, 0);
    // }

    public function playback-stopped-with-error(error: string) {
        Bridge.playing = false;
        error-alert.message = error;
        error-alert.show();
        // playback-control.playback-stopped();
    }

    public function update-progress-percent(percent: float) {
        // playback-control.update-progress-percent(percent);
    }

    FocusScope {
        capture-key-pressed(event) => Bridge.capture-key-pressed(event);
    }

    if Bridge.app-state == AppState.Idle: IdleView { }

    if Bridge.app-state == AppState.LoadingMedia: LoadingMediaView { }

    if Bridge.app-state == AppState.Playing && Bridge.player-variant == UiPlayerVariant.Video: VideoPlayerView { }

    if Bridge.app-state == AppState.Playing && Bridge.player-variant == UiPlayerVariant.Image: ImageView { }

    if Bridge.app-state == AppState.Playing && Bridge.player-variant == UiPlayerVariant.Audio: AudioPlayerView { }

    if Bridge.is-debugging: DebugOverlay { }

    error-alert := ErrorAlert {
        width: min(parent.width * 0.8, 700px);
        y: parent.height - self.height - 20px;
    }
}
